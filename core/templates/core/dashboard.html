{% extends 'core/base.html' %}
{% load static %}


{% block title %}Smart Bargain - User Dashboard{% endblock %}
<style>
    #negotiationDashboardTable input[type="checkbox"] {
        transform: scale(1.3);
        cursor: pointer;
    }

    .selected-row {
        background-color: #e0f7fa !important;
    }

    #negotiationDashboardTable tr {
        cursor: pointer;
    }

    .pagination-wrapper {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }
</style>


{% block content %}
<div class="wrapper">
    <div class="container" id="main">
        <div class="row gtr-150">
            <div class="col-12">
                <article id="content">
                    <header class="feature-header">
                        <img src="{% static 'core/images/Smart_Bargain_Logo.png' %}"  alt="Feature Logo" class="feature-logo">
                        <div class="feature-header-content">
                            <h2>Your Dashboard</h2>
                            <p>Track, analyze, and manage your activity‚Äîall in one place!</p>
                        </div>
                    </header>

                    {% if request.session.role == "seller" %}
                    <!-- Seller-only: New Negotiations -->
                    <article style="border: 1px solid #ccc; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <header>
                            <h2>New Negotiations</h2>
                            <p>This is an accessible table. Review and manage your negotiations below.</p>
                        </header>
                        <table id="negotiationTaskTable" aria-label="Negotiation Tasks Table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="padding: 8px; text-align: left; font-weight: bold;">Product</th>
                                    <th style="padding: 8px; text-align: right; font-weight: bold;">Quantity</th>
                                    <th style="padding: 8px; text-align: right; font-weight: bold;">Price</th>
                                    <th style="padding: 8px; text-align: center; font-weight: bold;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="negotiationTaskTableBody">
                                <!-- Rows will be injected via JS -->
                            </tbody>
                        </table>
                        <div id="negotiationPaginationControls" style="margin-top: 10px; text-align: center;"></div>
                    </article>
                    {% endif %}

                    <!-- Negotiation Dashboard: Visible to All -->
                    <article style="border: 1px solid #ccc; border-radius: 8px; padding: 16px; margin-top: 30px;">
                        <header>
                            <h2>Negotiation Dashboard</h2>
                            <p style="margin-bottom: 4px;">
							Review submitted negotiation responses below. Click a row to view and respond.
							</p>
							<p style="color: #b71c1c; font-size: 0.85em; font-style: italic; margin: 0;">
							‚ö†Ô∏è Note: Cancelled negotiation records cannot be further edited or responded to.
							</p>
                        </header>
						<!-- Filter by Status -->
						<div style="margin-bottom: 10px;">
						<label for="statusFilter"><strong>Filter by Status:</strong></label>
						<select id="statusFilter" onchange="applyStatusFilter()" style="margin-left: 10px;">
						<option value="all">All</option>
						<option value="Active">Active</option>
						<option value="Pending Buyer Approval">Pending Buyer Approval</option>
						<option value="Pending Seller Approval">Pending Seller Approval</option>
						<option value="Rejected">Rejected</option>
						<option value="Cancelled">Cancelled</option>
						</select>
						</div>

                        <table id="negotiationDashboardTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="width: 40px; text-align: center;">
                                        <input type="checkbox" onclick="toggleSelectAll(this)" />
                                    </th>
                                    <th style="padding: 8px; text-align: left; font-weight: bold;">Product</th>
                                    <th style="padding: 8px; text-align: right; font-weight: bold;">Quantity</th>
                                    <th style="padding: 8px; text-align: right; font-weight: bold;">Price</th>
                                    <th style="padding: 8px; text-align: left; font-weight: bold;">Comment</th>
                                    <th style="padding: 8px; text-align: center; font-weight: bold;">Status</th>
                                    <th style="padding: 8px; text-align: left; font-weight: bold;">Buyer</th>
                                    <th style="padding: 8px; text-align: left; font-weight: bold;">Seller</th>
                                </tr>
                            </thead>
                            <tbody id="negotiationDashboardTableBody">
                                <!-- JS will inject rows here -->
                            </tbody>
                        </table>
                        <div id="negotiationDashboardPaginationControls" style="margin-top: 10px; text-align: center;"></div>
                    </article>

                    <!-- Shared Negotiation Modal for All Users -->
                    <div id="negotiationModal" style="
                        display: none;
                        position: fixed;
                        top: 10%;
                        left: 50%;
                        transform: translate(-50%, 0);
                        width: 90%;
                        max-width: 500px;
                        max-height: 80vh;
                        overflow-y: auto;
                        background: white;
                        border: 1px solid #ccc;
                        border-radius: 10px;
                        z-index: 1000;
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                        
                        <!-- Drag Handle -->
                        <div id="modalHeader" style="cursor: move; background-color: #f0f0f0; padding: 10px; border-bottom: 1px solid #ccc;">
                            <h3 style="margin: 0;">Negotiation Details</h3>
                        </div>

                        <!-- Modal Body -->
                        <div style="padding: 20px;">
                            <div><label><strong>Product:</strong></label><p id="modalProductName"></p></div>
                            <div><label><strong>Status:</strong></label><p id="modalStatus"></p></div>
                            <div><label><strong>Buyer:</strong></label><p id="modalBuyer"></p></div>
                            <div><label><strong>Seller:</strong></label><p id="modalSeller"></p></div>

                            <div style="margin-top: 10px;">
                                <label>Quantity:</label>
                                <input type="number" id="modalQuantity" style="width: 100%;" />
                            </div>

                            <div style="margin-top: 10px;">
                                <label>Price:</label>
                                <input type="number" step="0.01" id="modalPrice" style="width: 100%;" />
                            </div>

                            <div style="margin-top: 10px;">
                                <label>Comments:</label>
                                <textarea id="modalComments" rows="3" style="width: 100%;"></textarea>
                            </div>

                            <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
                                <button onclick="submitNegotiationResponse('accept')">Accept</button>
                                <button onclick="submitNegotiationResponse('reject')">Reject</button>
                                <button id="counterProposeBtn" onclick="submitNegotiationResponse('counter')" disabled>Counter Propose</button>
                                <button onclick="submitNegotiationResponse('cancel')">Cancel</button>
                                <button onclick="closeNegotiationModal()">Close Window</button>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Backdrop -->
                    <div id="modalBackdrop" style="
                        display: none;
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100vw;
                        height: 100vh;
                        background: rgba(0,0,0,0.4);
                        z-index: 999;"
                        onclick="closeNegotiationModal()">
                    </div>

                    <!-- Orders Table -->
                    <article style="border: 1px solid #ccc; border-radius: 8px; padding: 16px; margin-top: 20px;">
                        <header>
                            <h2 style="margin-top: 0;">Order History</h2>
                        </header>
                        <section>
                            <table id="ordersTable" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr>
                                        <th style="padding: 8px; text-align: left; font-weight: bold;">Product</th>
                                        <th style="padding: 8px; text-align: right; font-weight: bold;">Quantity</th>
                                        <th style="padding: 8px; text-align: right; font-weight: bold;">Price</th>
                                        <th style="padding: 8px; text-align: center; font-weight: bold;">Status</th>
                                        <th style="padding: 8px; text-align: center; font-weight: bold;">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <!-- Order rows will be loaded via JS -->
                                </tbody>
                            </table>
                        </section>
                    </article>

                </article>
                <div id="paginationControls" style="margin-top: 10px; text-align: center;"></div>
            </div>
        </div>
    </div>

{% if request.session.role == "seller" %}
	<article style="border: 1px solid #ccc; border-radius: 8px; padding: 16px; margin-top: 30px; max-width: 900px; margin-left: auto; margin-right: auto;">
		<header>
			<h2>Contact Messages</h2>
        <p>Review customer messages. Use filters or click a row for full details.</p>
    </header>

		<!-- Filter Controls -->
		<div style="margin-bottom: 10px; display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">
		<label for="messageStatusFilter"><strong>Status:</strong></label>
		<select id="messageStatusFilter">
			<option value="all">All</option>
			<option value="open">Open</option>
			<option value="closed">Closed</option>
		</select>

		<label for="messageDateFilter"><strong>Date:</strong></label>
		<input type="date" id="messageDateFilter" />

		<button onclick="clearMessageFilters()" style="padding: 6px 12px; border: 1px solid #ccc; background: #f5f5f5; border-radius: 4px; cursor: pointer;">
        Clear Filters
		</button>
		</div>

		<!-- Messages Table -->
		<section>
			<div style="overflow-x: auto;">
				<table id="messagesTable" style="width: 100%; border-collapse: collapse; table-layout: fixed;">
					<thead>
						<tr style="background-color: #f5f5f5;">
						<th style="padding: 8px; text-align: left; font-weight: bold;">Name</th>
						<th style="padding: 8px; text-align: center; font-weight: bold;">Status</th>
						<th style="padding: 8px; text-align: center; font-weight: bold;">Date</th>
						</tr>
					</thead>
					<tbody id="messagesTableBody">
						<!-- JS will populate -->
					</tbody>
					<tbody id="noMessagesRow" style="display: none;">
						<tr>
							<td colspan="3" style="text-align: center; padding: 12px; color: #999;">
							No messages found for the selected criteria.
							</td>
						</tr>
					</tbody>
				</table>
			<div id="messagePagination" style="text-align: center; margin-top: 10px;"></div>
		</section>
	</article>
	<!-- Message Detail Modal -->
	<div id="messageModal" style="
		display: none;
		position: fixed;
		top: 10%;
		left: 50%;
		transform: translate(-50%, 0);
		width: 90%;
		max-width: 500px;
		background: white;
		border: 1px solid #ccc;
		border-radius: 10px;
		z-index: 1000;
		box-shadow: 0 4px 10px rgba(0,0,0,0.2);">

    <!-- Modal Header -->
    <div style="background-color: #f5f5f5; padding: 10px; border-bottom: 1px solid #ccc;">
        <h3 style="margin: 0;">Contact Message Detail</h3>
    </div>

    <!-- Modal Content -->
    <div style="padding: 20px;">
        <div><label><strong>Name:</strong></label><p id="modalMsgName"></p></div>
        <div><label><strong>Email:</strong></label><p id="modalMsgEmail"></p></div>
        <div><label><strong>Message:</strong></label><p id="modalMsgMessage" style="white-space: pre-wrap;"></p></div>
        <div><label><strong>Status:</strong></label><p id="modalMsgStatus"></p></div>
        <div><label><strong>Date:</strong></label><p id="modalMsgDate"></p></div>

        <!-- Modal Buttons -->
        <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
            <button onclick="replyToMessage()">Reply</button>
            <button onclick="closeMessageThread()">Close Message</button>
            <button onclick="closeMessageModal()">Exit Page</button>
        </div>
    </div>
</div>


{% endif %}
</div>
<script>
    const userEmail = "{{ request.session.email }}";
    const userRole = "{{ request.session.role }}";

    let originalQuantity = null;
    let originalPrice = null;

    function getCSRFToken() {
        return document.cookie
            .split("; ")
            .find(row => row.startsWith("csrftoken="))
            ?.split("=")[1];
    }

    function loadNegotiationTasks() {
        fetch("/get_negotiation_tasks/")
            .then(response => response.json())
            .then(data => {
                const allTasks = data.tasks || [];
                const table = document.getElementById("negotiationTaskTableBody");
                const paginationDiv = document.getElementById("negotiationPaginationControls");
                const rowsPerPage = 5;
                let currentPage = 1;

                function renderTable(page) {
                    table.innerHTML = "";
                    const start = (page - 1) * rowsPerPage;
                    const end = start + rowsPerPage;
                    const pageTasks = allTasks.slice(start, end);

                    if (pageTasks.length === 0) {
                        table.innerHTML = "<tr><td colspan='4'>No negotiation tasks found.</td></tr>";
                        return;
                    }

                    pageTasks.forEach(task => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td style="padding: 8px;">${task.product}</td>
                            <td style="padding: 8px; text-align: right;">${task.quantity}</td>
                            <td style="padding: 8px; text-align: right;">$${parseFloat(task.price).toFixed(2)}</td>
                            <td style="padding: 8px; text-align: center;">${task.status}</td>
                        `;
                        row.style.cursor = "pointer";
                        row.onclick = () => {
                            window.currentNegotiationRowId = task.id;
                            openNegotiationModal(task, "new_task");
                        };
                        table.appendChild(row);
                    });
                }

                function renderPagination() {
                    paginationDiv.innerHTML = "";
                    const totalPages = Math.ceil(allTasks.length / rowsPerPage);
                    for (let i = 1; i <= totalPages; i++) {
                        const btn = document.createElement("button");
                        btn.textContent = i;
                        btn.style.margin = "0 4px";
                        btn.disabled = i === currentPage;
                        btn.onclick = () => {
                            currentPage = i;
                            renderTable(currentPage);
                            renderPagination();
                        };
                        paginationDiv.appendChild(btn);
                    }
                }

                renderTable(currentPage);
                renderPagination();
            })
            .catch(error => {
                console.error("Failed to load negotiation tasks:", error);
            });
    }


    function loadOrders() {
    console.log("üîÑ Fetching orders...");

    fetch("/get_orders/")
        .then(response => response.json())
        .then(data => {
            const orders = data.orders || [];
            const table = document.getElementById("ordersTableBody");
            const paginationDiv = document.getElementById("paginationControls");
			paginationDiv.className = "pagination-wrapper";
            const rowsPerPage = 5;
            let currentPage = 1;

            function renderTable(page) {
                table.innerHTML = "";
                const start = (page - 1) * rowsPerPage;
                const end = start + rowsPerPage;
                const pageData = orders.slice(start, end);

                if (pageData.length === 0) {
                    table.innerHTML = "<tr><td colspan='5'>No orders found.</td></tr>";
                    return;
                }

                pageData.forEach(order => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td style="padding: 8px; text-align: left;">${order.product}</td>
                        <td style="padding: 8px; text-align: right;">${order.qty}</td>
                        <td style="padding: 8px; text-align: right;">$${parseFloat(order.price).toFixed(2)}</td>
                        <td style="padding: 8px; text-align: center;">${order.status}</td>
                        <td style="padding: 8px; text-align: center;">${new Date(order.date).toLocaleString()}</td>
                    `;
                    table.appendChild(row);
                });
            }

            function renderPagination() {
                paginationDiv.innerHTML = "";
                const totalPages = Math.ceil(orders.length / rowsPerPage);
                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement("button");
                    btn.textContent = i;
                    btn.style.margin = "0 4px";
                    btn.disabled = i === currentPage;
                    btn.onclick = () => {
                        currentPage = i;
                        renderTable(currentPage);
                        renderPagination();
                    };
                    paginationDiv.appendChild(btn);
                }
            }

            renderTable(currentPage);
            renderPagination();
        })
        .catch(error => {
            console.error("‚ùå Error loading orders:", error);
        });
}

document.addEventListener("DOMContentLoaded", () => {
    loadOrders();

    // Auto-load contact messages if the table exists - this is for message table 
    if (document.getElementById('messagesTableBody')) {
        loadContactMessages();  // default load with 'all'
    }

    // Add filter listener for message status (open/closed/all) - this is for message table
    const filter = document.getElementById('messageStatusFilter');
    if (filter) {
        filter.addEventListener('change', () => {
            const status = filter.value;
            currentMessagePage = 1;  // reset to first page on filter change
            loadContactMessages(status);
        });
    }
});

    function openNegotiationModal(task, source = "dashboard") {
        document.getElementById("modalProductName").innerText = task.product;
        document.getElementById("modalQuantity").value = task.quantity;
        document.getElementById("modalPrice").value = task.price || "";
        document.getElementById("modalComments").value = task.comment || "";
        document.getElementById("modalStatus").innerText = task.status || "";
        document.getElementById("modalBuyer").innerText = task.buyer || "";
        document.getElementById("modalSeller").innerText = task.seller || "";

        originalQuantity = task.quantity;
        originalPrice = parseFloat(task.price);

        document.getElementById("negotiationModal").style.display = "block";
        document.getElementById("modalBackdrop").style.display = "block";
        window.currentNegotiationId = task.id;
		window.currentNegotiationSource = source;

        document.getElementById("modalQuantity").addEventListener("input", checkCounterProposalValidity);
        document.getElementById("modalPrice").addEventListener("input", checkCounterProposalValidity);

        checkCounterProposalValidity();
    }

    function checkCounterProposalValidity() {
        const newQty = parseInt(document.getElementById("modalQuantity").value);
        const newPrice = parseFloat(document.getElementById("modalPrice").value);

        const isQtyChanged = newQty !== originalQuantity;
        const isPriceChanged = !isNaN(newPrice) && newPrice !== originalPrice;

        const counterButton = document.getElementById("counterProposeBtn");

        if (isQtyChanged || isPriceChanged) {
            counterButton.disabled = false;
            counterButton.style.opacity = 1;
            counterButton.style.cursor = "pointer";
        } else {
            counterButton.disabled = true;
            counterButton.style.opacity = 0.5;
            counterButton.style.cursor = "not-allowed";
        }
    }

    function closeNegotiationModal() {
        document.getElementById("negotiationModal").style.display = "none";
        document.getElementById("modalBackdrop").style.display = "none";
    }
	

    function submitNegotiationResponse(action) {
    const quantity = parseInt(document.getElementById("modalQuantity").value);
    const price = parseFloat(document.getElementById("modalPrice").value);
    const comment = document.getElementById("modalComments").value;

    const source = window.currentNegotiationSource;
    const negotiationId = window.currentNegotiationRowId;
    const userRole = "{{ request.session.role|escapejs }}";

    const payload = {
        quantity: quantity,
        price: price,
        comment: comment,
        action: action  // Keep action for backend logic
    };

    // ‚úÖ Set status correctly
    const statusMap = {
		"accept": "Accepted",
		"reject": "Rejected",
		"cancel": "Cancelled",
		"counter": userRole === "buyer"
			? "Pending Seller Approval"
			: "Pending Buyer Approval"
	};

	payload.status = statusMap[action] || "Pending";

    let url = "";
    if (source === "new_task") {
        url = "/submit_negotiation_response/";
        payload.bargain_id = negotiationId;
    } else {
        url = "/update_negotiation_dashboard/";
        payload.negotiation_id = negotiationId;
    }

    console.log("Payload being sent:", payload); // ‚úÖ Debugging log

    fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken(),
        },
        credentials: "include",
        body: JSON.stringify(payload),
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert("‚úÖ " + data.message);
            closeNegotiationModal();
            loadNegotiationDashboard();
            loadNegotiationTasks();
            loadOrders();
        } else {
            alert("‚ùå " + (data.error || "Update failed."));
        }
    })
    .catch(error => {
        alert("‚ö†Ô∏è Error submitting negotiation response.");
        console.error(error);
    });
}






    function loadNegotiationDashboard() {
    fetch("/get_negotiation_dashboard/")
        .then(response => response.json())
        .then(data => {
            const records = data.records || [];
            const tableBody = document.getElementById("negotiationDashboardTableBody");
            const paginationDiv = document.getElementById("negotiationDashboardPaginationControls");
            const rowsPerPage = 5;
            let currentPage = 1;
            let selectedRow = null;

            function renderTable(page) {
                tableBody.innerHTML = "";
                const start = (page - 1) * rowsPerPage;
                const end = start + rowsPerPage;

                const selectedStatus = document.getElementById("statusFilter").value;
                const filteredRecords = selectedStatus === "all"
                    ? records
                    : records.filter(r => r.status === selectedStatus);

                const pageData = filteredRecords.slice(start, end);

                if (pageData.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='8'>No negotiation records found.</td></tr>";
                    return;
                }

                pageData.forEach(record => {
                    const row = document.createElement("tr");
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.value = record.id;
                    checkbox.style.transform = "scale(1.3)";
                    checkbox.style.cursor = "pointer";

                    const checkboxCell = document.createElement("td");
                    checkboxCell.style.textAlign = "center";
                    checkboxCell.appendChild(checkbox);
                    row.appendChild(checkboxCell);

                    const cells = [
                        { text: record.product, align: "left" },
                        { text: record.qty || record.quantity || "-", align: "right" },
                        { text: `$${parseFloat(record.price).toFixed(2)}`, align: "right" },
                        { text: record.comment, align: "left" },
                        { text: record.status, align: "center" },
                        { text: record.buyer, align: "left" },
                        { text: record.seller, align: "left" },
                    ];

                    cells.forEach(cell => {
                        const td = document.createElement("td");
                        td.style.textAlign = cell.align;
                        td.textContent = cell.text;
                        row.appendChild(td);
                    });

                    checkbox.addEventListener("change", () => {
                        document.querySelectorAll("#negotiationDashboardTableBody input[type='checkbox']").forEach(cb => {
                            if (cb !== checkbox) cb.checked = false;
                        });
                        document.querySelectorAll("#negotiationDashboardTableBody tr").forEach(r => {
                            r.classList.remove("selected-row");
                        });
                        if (checkbox.checked) {
                            row.classList.add("selected-row");
                            selectedRow = row;
                        } else {
                            selectedRow = null;
                        }
                    });

                    row.addEventListener("click", (event) => {
                        if (event.target.type === "checkbox") return;
						if (record.status === "Cancelled") return;
                        checkbox.checked = true;
                        checkbox.dispatchEvent(new Event("change"));
                        window.currentNegotiationRowId = record.id;
                        openNegotiationModal(record, "dashboard");
                    });
					
					if (record.status === "Cancelled") {
					row.style.backgroundColor = "#f0f0f0"; // light grey
					row.style.cursor = "not-allowed";      // visual cue
					row.classList.add("cancelled-row");    // optional for reuse
					}

                    tableBody.appendChild(row);
                });
            }

            function renderPagination() {
                paginationDiv.innerHTML = "";
                const selectedStatus = document.getElementById("statusFilter").value;
                const filteredRecords = selectedStatus === "all"
                    ? records
                    : records.filter(r => r.status === selectedStatus);
                const totalPages = Math.ceil(filteredRecords.length / rowsPerPage);
                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement("button");
                    btn.textContent = i;
                    btn.style.margin = "0 4px";
                    btn.disabled = i === currentPage;
                    btn.onclick = () => {
                        currentPage = i;
                        renderTable(currentPage);
                        renderPagination();
                    };
                    paginationDiv.appendChild(btn);
                }
            }

            window.applyStatusFilter = function () {
                currentPage = 1;
                renderTable(currentPage);
                renderPagination();
            };

            renderTable(currentPage);
            renderPagination();
        })
        .catch(error => {
            console.error("Failed to load negotiation dashboard:", error);
        });
}


    function toggleSelectAll(masterCheckbox) {
        const checkboxes = document.querySelectorAll("#negotiationDashboardTableBody input[type='checkbox']");
        checkboxes.forEach(cb => cb.checked = masterCheckbox.checked);
    }
	
	function makeModalDraggable(modalId, handleId) {
    const modal = document.getElementById(modalId);
    const handle = document.getElementById(handleId);
    let offsetX = 0, offsetY = 0, isDragging = false;

    handle.addEventListener("mousedown", (e) => {
        isDragging = true;
        offsetX = e.clientX - modal.getBoundingClientRect().left;
        offsetY = e.clientY - modal.getBoundingClientRect().top;
        document.body.style.userSelect = "none";
    });

    document.addEventListener("mouseup", () => {
        isDragging = false;
        document.body.style.userSelect = "";
    });

    document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        modal.style.top = `${e.clientY - offsetY}px`;
		modal.style.left = `${e.clientX - offsetX}px`;
		modal.style.transform = "none";  // Cancel centering to allow free dragging
    });
}

    document.addEventListener("DOMContentLoaded", () => {
        loadNegotiationTasks();
        loadOrders();
        loadNegotiationDashboard();
		makeModalDraggable("negotiationModal", "modalHeader");
    });
</script>
{% endblock %}
